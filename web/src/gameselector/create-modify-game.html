<dom-module id="ghvz-create-modify-game">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-create-modify-game',

        properties: {
          bridge: Object,
          userId: String,
          game: {
            type: Object,
            value: null,
          }
        },

        observers: ['onRulesChanged_(game.rulesHtml)'],

        onRulesChanged_(rulesHtml) {
          this.$$("#rules").innerHTML = rulesHtml;
        },

        makeFormBlueprint_: function() {
          return {
            fields: [
              {
                property: "id",
                label: "Id",
                description: "Will appear in the url, keep it short. 'game-' will be automatically prepended. Example '2017m' will become 'game-2017m'.",
                width: "third",
              },
              {
                property: "name",
                label: "Name",
                width: "third",
                description: "Full name for the game.",
              },
              {
                property: "stunTimer",
                label: "Stun timer (in seconds)",
                description: "Stun timer, in seconds.",
                type: 'number',
                width: "third",
              },
              {
                property: "rulesHtml",
                label: "Rules html",
                description: "HTML describing the rules",
                type: 'text',
              },
            ],
          };
        },

        editGame_: function() {
          this.$.gameForm.openForEditing(this.game)
              .then((properties) => {
                properties.gameId = this.game.id;
                delete properties.id;
                this.bridge.updateGame(properties);
              });
        },

        addGame_: function() {
          this.$.gameForm.openForAdding()
              .then((properties) => {
                let gameId = properties.id;
                if (!gameId.startsWith('game-'))
                  gameId = 'game-' + properties.id;
                this.bridge.createGame({
                  gameId: gameId,
                  stunTimer: +properties.stunTimer,
                  adminUserId: this.userId,
                  active: true,
                  rulesHtml: properties.rulesHtml,
                  name: properties.name,
                });
                var resistanceGroupId = Bridge.GroupId.generate('resistance');
                this.bridge.createGroup({
                  groupId: resistanceGroupId,
                  gameId: gameId,
                  ownerPlayerId: null,
                  allegianceFilter: 'resistance',
                  autoAdd: true,
                  autoRemove: true,
                  membersCanAdd: false,
                  membersCanRemove: false,
                });
                var resistanceChatRoomId = Bridge.ChatRoomId.generate();
                this.bridge.createChatRoom({
                  chatRoomId: resistanceChatRoomId,
                  groupId: resistanceGroupId,
                  name: "Resistance Comms Hub",
                  withAdmins: false
                });
                var hordeGroupId = Bridge.GroupId.generate('horde');
                this.bridge.createGroup({
                  groupId: hordeGroupId,
                  gameId: gameId,
                  ownerPlayerId: null,
                  allegianceFilter: 'horde',
                  autoAdd: true,
                  membersCanAdd: true,
                  autoRemove: true,
                  membersCanAdd: false,
                  membersCanRemove: false,
                });
                var zedChatRoomId = Bridge.ChatRoomId.generate();
                this.bridge.createChatRoom({
                  chatRoomId: zedChatRoomId,
                  groupId: hordeGroupId,
                  name: "Horde ZedLink",
                  withAdmins: false,
                });
              });
        },
      });
    });
  </script>
  <style>
    :host {
      display: flex;
    }
    #create, #modify {
      display: none;
    }
    paper-button {
      background-color: #9C27B0;
      color: white;
    }
    :host[modify] paper-button {
      margin: 0 0 8px 0;
    }
    :host[create] #create {
      display: block;
    }
    :host[modify] #modify {
      display: block;
    }
    #rules {
      margin-top: 8px;
    }
  </style>
  <template>
    <paper-button id="create" raised on-tap="addGame_">Create Game</paper-button>
    <ghvz-super-form
        id="gameForm"
        type-name="Game"
        blueprint="[[makeFormBlueprint_()]]">
      <ghvz-form-section spaced>
        For timestamps, use <a href="https://www.epochconverter.com/">epochconverter</a>.
        Timestamps are in milliseconds.
      </ghvz-form-section>
    </ghvz-super-form>

    <div hidden$="[[!game]]">
      <paper-button id="modify" raised on-tap="editGame_">Modify Game</paper-button>
      <div>ID: <b>[[game.id]]</b></div>
      <div>Name: <b>[[game.name]]</b></div>
      <div>Stun Timer: <b>[[game.stunTimer]]</b></div>
      <div id="rules"></div>
    </div>
  </template>
</dom-module>
